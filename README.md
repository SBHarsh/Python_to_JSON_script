# 🧠 Dynamic Painless Script Generator

This project automates the generation of **Elasticsearch Painless scripts** by reading **rule definitions from Excel**.  
It dynamically constructs complex aggregation logic (`scripted_metric`) for **Numerator** and **Denominator** calculations — saving hours of manual effort and ensuring consistency across multiple rule sets.

---

## 🚀 Features

- ✅ Reads business rules from an Excel file (`rules.xlsx`)
- ⚙️ Automatically parses rules (e.g., *Filter*, *Exclude*, *Unfilter*, *Contain*, etc.)
- 🔄 Dynamically generates a valid **Elasticsearch aggregation JSON**
- 📄 Outputs a clean, production-ready `generated_painless.json` file
- 🧩 Easily adaptable to any metric or rule definition

---

## 📂 Project Structure

      Dynamic_Painless_Script_Generator/
      ├── main.py                   # Main Python script
      ├── rules.xlsx                # Input Excel containing Numerator/Denominator rules
      ├── generated_painless.json   # Output JSON generated by the script
      └── README.md                 # Project documentation

---

## 📘 How It Works

1. **Define your rules in Excel** like this:

| A (Column 0) | B (Column 1) |
|---------------|--------------|
| Numerator | 1. Exclude line where column "A (ColA Name)" = "val1"<br>2. Filter column "B (ColB Name)" contain "val2"<br>3. Filter column "D (ColD Name)" to "val3"<br>4. Filter column "C (ColC Name)" to "val4"<br>5. Unfilter column "K (ColK Name)" to "val5"<br>6. Get sum of column "L (ColL Name)"<br>7. Get Average of column "J (ColJ Name)"<br>8. Numerator = (sum of column "L (ColL Name)" * Average of column "J (ColJ Name)"/100) |
| Denominator | 1. Exclude line where column "A (ColA Name)" = "val1"<br>2. Filter column "B (ColB Name)" contain "val2"<br>3. Filter column "D (ColD Name)" to "val3"<br>4. Filter column "C (ColC Name)" to "val4"<br>5. Unfilter column "K (ColK Name)" to "val5"<br>6. Get sum of column "L (ColL Name)" |

2. **Run the Python script**.  
   It will:
   - Read your Excel file  
   - Parse the rules  
   - Build equivalent Painless logic  
   - Generate an Elasticsearch-ready JSON file

3. **Output file** (`generated_painless.json`) contains your scripted metric ready for ingestion.

---

## ⚙️ Setup & Usage

### 🔧 Requirements
- Python 3.8 or above  
- Required libraries:
  ```bash
  pip install pandas openpyxl
▶️ Run the Script

Place your rule definitions in rules.xlsx

Update the input/output paths in main.py

Run:  
python main.py
Output:
✅ Dynamic painless JSON generated successfully → generated_painless.json

---

### Example Output
{
  "aggs": {
    "group_by_sl_met": {
      "scripted_metric": {
        "map_script": "if(params['_source']['ColA Name']!= 'val1'){if(params['_source']['ColB Name'] == 'val2'){if(params['_source']['ColD Name']=='val3'){if(params['_source']['ColC Name'] == 'val4'){if(params['_source']['ColK Name']!= 'val5'){state.map.var += (doc['ColL Name'].value)}}}}}  if(params['_source']['ColA Name']!= 'val1'){if(params['_source']['ColB Name']== 'val2'){if(params['_source']['ColD Name']=='val3'){if(params['_source']['ColC Name'] == 'val4'){if(params['_source']['ColK Name']!= 'val5'){state.map.var1 += (doc['ColJ Name'].value)}}}}}  if(params['_source']['ColA Name']!= 'val1'){if(params['_source']['ColB Name']== 'val2'){if(params['_source']['ColD Name']=='val3'){if(params['_source']['ColC Name'] == 'val4'){if(params['_source']['ColK Name']!= 'val5'){state.map.var2++}}}}}",
        "init_script": "state['map'] = ['var': 0.0, 'var1': 0.0, 'var2': 0.0]",
        "combine_script": "return state",
        "reduce_script": "def return_map = ['Final_Performance': 0.0, 'Final_Numerator': 0.0, 'Final_Denominator': 0.0]; def new_map = ['num1': 0.0, 'num2': 0.0, 'num3': 0.0, 'num': 0.0, 'den': 0.0]; for(a in states){new_map.num1 += (a.map.var); new_map.num2 += (a.map.var1); new_map.num3 += (a.map.var2); new_map.num = (new_map.num1*((new_map.num2/new_map.num3)*100))/100.00; new_map.den += a.map.var;} if(new_map.den!=0){return_map.Final_Performance = Math.floor((float)(new_map.num)/(new_map.den)*10000.0)/100.0}else{return_map.Final_Performance='';return_map.SL_Met=5;}return_map.Final_Denominator = new_map.den;return_map.Final_Numerator = new_map.num; return return_map;"
      }
    }
  },
  "size": 0,
  "query": {
    "bool": {
      "must": [
        { "match": { "childslaId": "childSLAId" } },
        { "match": { "useInComputation": true } }
      ]
    }
  }
}

---

### 🧱  Customization
Change column names (ColA, ColB, etc.) in your Excel as per your dataset.
Add or remove filters — the parser automatically adjusts.
Modify reduce_script logic if you want a different metric computation.

---

### 🧑‍💻 Author

Harsh Kumar
Software Engineer
📧 [Add your email or LinkedIn here if you’d like]

---

### 🌟 Acknowledgements

Elasticsearch for the Painless scripting framework
Pandas + OpenPyXL for robust Excel parsing
Python community for making automation so accessible
